#creating a namespace for our work

ajuser:~/deployments2 $ kubectl apply -f kubernetes/namespace.yml 
namespace/kafka created

ajuser:~/deployments2 $ kubectl get pods --namespace kafka
No resources found in kafka namespace.

#deploying a pod for zookeeper using 'zookeeper.yml' file

ajuser:~/deployments2 $ kubectl apply -f kubernetes/orig-e1/zookeeper.yml
statefulset.apps/zoo created
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS              RESTARTS   AGE
zoo-0   0/1     ContainerCreating   0          8s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS              RESTARTS   AGE
zoo-0   0/1     ContainerCreating   0          12s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS              RESTARTS   AGE
zoo-0   0/1     ContainerCreating   0          15s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS              RESTARTS   AGE
zoo-0   0/1     ContainerCreating   0          18s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS    RESTARTS   AGE
zoo-0   0/1     Running   0          20s

#connecting to pod throws error msg as we need to point to namespace
ajuser:~ $ kubectl exec -it zoo-0 /bin/bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Error from server (NotFound): pods "zoo-0" not found

#connecting again and getting into pod>container
ajuser:~/deployments2 $ kubectl get pods --namespace kafka --namespace kafka
NAME    READY   STATUS    RESTARTS   AGE
zoo-0   1/1     Running   0          4m50s
ajuser:~/deployments2 $ kubectl exec -it zoo-0 /bin/bash --namespace kafka
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
root@zoo-0:/opt/zookeeper-3.4.13# zkCli.sh
bash: zkCli.sh: command not found
root@zoo-0:/opt/zookeeper-3.4.13# bin/zkCli.sh
command terminated with exit code 137

#commands exits with 137 which shows memory issue and might be container is terminated, let's check

ajuser:~ $ kubectl get pods --namespace kafka
NAME    READY   STATUS    RESTARTS   AGE
zoo-0   0/1     Running   2          2m16s

#doing a describe on pod
ajuser:~ $ kubectl describe pod zoo-0 --namespace kafka
ajuser:~/deployments2 $ kubectl describe pod zoo-0 --namespace kafka
Name:         zoo-0
Namespace:    kafka
Priority:     0
Node:         ip-192-168-55-180.eu-central-1.compute.internal/192.168.55.180
Start Time:   Wed, 25 Aug 2021 09:05:56 +0000
Labels:       app=zookeeper
              controller-revision-hash=zoo-6987998545
              statefulset.kubernetes.io/pod-name=zoo-0
              storage=persistent-regional
Annotations:  kubernetes.io/psp: eks.privileged
Status:       Running
IP:           192.168.53.2
IPs:
  IP:           192.168.53.2
Controlled By:  StatefulSet/zoo
Containers:
  zookeeper:
    Container ID:   docker://0292c6e8db79354502cb9f88f0afd91f4ddcd6a5db4ad33cb053b50073a2cf1d
    Image:          wurstmeister/zookeeper
    Image ID:       docker-pullable://wurstmeister/zookeeper@sha256:7a7fd44a72104bfbd24a77844bad5fabc86485b036f988ea927d1780782a6680
    Ports:          2181/TCP, 2888/TCP, 3888/TCP
    Host Ports:     0/TCP, 0/TCP, 0/TCP
    State:          Running
      Started:      Wed, 25 Aug 2021 09:11:21 +0000
    Last State:     Terminated
      Reason:       OOMKilled
      Exit Code:    137
      Started:      Wed, 25 Aug 2021 09:06:13 +0000
      Finished:     Wed, 25 Aug 2021 09:11:19 +0000
    Ready:          True
    Restart Count:  1
    Limits:
      memory:  120Mi
    Requests:
      cpu:      10m
      memory:   100Mi
    Readiness:  exec [/bin/sh -c [ "imok" = "$(echo ruok | nc -w 1 -q 1 127.0.0.1 2181)" ]] delay=0s timeout=2s period=30s #success=1 #failure=3
    Environment:
      POD_NAME:          zoo-0 (v1:metadata.name)
      KAFKA_LOG4J_OPTS:  -Dlog4j.configuration=file:/etc/kafka/log4j.properties
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-864tw (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  default-token-864tw:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-864tw
    Optional:    false
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age                  From               Message
  ----    ------     ----                 ----               -------
  Normal  Scheduled  6m45s                default-scheduler  Successfully assigned kafka/zoo-0 to ip-192-168-55-180.eu-central-1.compute.internal
  Normal  Pulled     6m29s                kubelet            Successfully pulled image "wurstmeister/zookeeper" in 15.38650581s
  Normal  Pulling    81s (x2 over 6m44s)  kubelet            Pulling image "wurstmeister/zookeeper"
  Normal  Created    80s (x2 over 6m28s)  kubelet            Created container zookeeper
  Normal  Started    80s (x2 over 6m28s)  kubelet            Started container zookeeper
  Normal  Pulled     80s                  kubelet            Successfully pulled image "wurstmeister/zookeeper" in 1.151859409s

#Delete the pod
#Edit the zookeeper.yml 
#Deploy the pod again..

ajuser:~/deployments2 $ kubectl delete -f kubernetes/orig-e1/zookeeper.yml                                                                                
statefulset.apps "zoo" deleted
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   1/1     Terminating   1          7m54s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   1/1     Terminating   1          7m59s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   1/1     Terminating   1          8m3s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   0/1     Terminating   1          8m5s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   0/1     Terminating   1          8m9s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
NAME    READY   STATUS        RESTARTS   AGE
zoo-0   0/1     Terminating   1          8m14s
ajuser:~/deployments2 $ kubectl get pods --namespace kafka
No resources found in kafka namespace.

ajuser:~/deployments2 $ kubectl apply -f kubernetes/orig-e2/zookeeper.yml 
statefulset.apps/zoo created

ajuser:~ $ kubectl get pods --namespace kafka
NAME    READY   STATUS    RESTARTS   AGE
zoo-0   1/1     Running   0          54s

ajuser:~ $ kubectl exec -it zoo-0 /bin/bash --namespace kafka                                                                              
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

root@zoo-0:/opt/zookeeper-3.4.13# bin/zkCli.sh
Connecting to localhost:2181
2021-08-25 09:17:37,387 [myid:] - INFO  [main:Environment@100] - Client environment:zookeeper.version=3.4.13-2d71af4dbe22557fda74f9a9b4309b15a7487f03, built on 06/29/2018 04:05 GMT
2021-08-25 09:17:37,391 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=zoo-0.zoo.kafka.svc.cluster.local
2021-08-25 09:17:37,391 [myid:] - INFO  [main:Environment@100] - Client environment:java.version=1.7.0_65
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.vendor=Oracle Corporation
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.home=/usr/lib/jvm/java-7-openjdk-amd64/jre
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.class.path=/opt/zookeeper-3.4.13/bin/../build/classes:/opt/zookeeper-3.4.13/bin/../build/lib/*.jar:/opt/zookeeper-3.4.13/bin/../lib/slf4j-log4j12-1.7.25.jar:/opt/zookeeper-3.4.13/bin/../lib/slf4j-api-1.7.25.jar:/opt/zookeeper-3.4.13/bin/../lib/netty-3.10.6.Final.jar:/opt/zookeeper-3.4.13/bin/../lib/log4j-1.2.17.jar:/opt/zookeeper-3.4.13/bin/../lib/jline-0.9.94.jar:/opt/zookeeper-3.4.13/bin/../lib/audience-annotations-0.5.0.jar:/opt/zookeeper-3.4.13/bin/../zookeeper-3.4.13.jar:/opt/zookeeper-3.4.13/bin/../src/java/lib/*.jar:/opt/zookeeper-3.4.13/bin/../conf:
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.io.tmpdir=/tmp
2021-08-25 09:17:37,395 [myid:] - INFO  [main:Environment@100] - Client environment:java.compiler=<NA>
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:os.name=Linux
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:os.arch=amd64
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:os.version=5.4.129-63.229.amzn2.x86_64
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:user.name=root
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:user.home=/root
2021-08-25 09:17:37,396 [myid:] - INFO  [main:Environment@100] - Client environment:user.dir=/opt/zookeeper-3.4.13
2021-08-25 09:17:37,398 [myid:] - INFO  [main:ZooKeeper@442] - Initiating client connection, connectString=localhost:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@674e5e21
2021-08-25 09:17:37,419 [myid:] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1029] - Opening socket connection to server localhost/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)
Welcome to ZooKeeper!
2021-08-25 09:17:37,424 [myid:] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@879] - Socket connection established to localhost/127.0.0.1:2181, initiating session
JLine support is enabled
2021-08-25 09:17:37,466 [myid:] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1303] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x10000205b1f0000, negotiated timeout = 30000

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
[zk: localhost:2181(CONNECTED) 0] ls /
[zookeeper]
[zk: localhost:2181(CONNECTED) 1] ls /zookeeper
[quota]

ajuser:~/deployments2 $ kubectl exec -it zoo-0 /bin/bash --namespace kafka
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
root@zoo-0:/opt/zookeeper-3.4.13# echo stat | nc localhost 2181
Zookeeper version: 3.4.13-2d71af4dbe22557fda74f9a9b4309b15a7487f03, built on 06/29/2018 04:05 GMT
Clients:
 /127.0.0.1:36010[0](queued=0,recved=1,sent=0)

Latency min/avg/max: 0/1/11
Received: 19
Sent: 18
Connections: 1
Outstanding: 0
Zxid: 0x2
Mode: standalone
Node count: 4

ajuser:~/deployments2 $ kubectl describe pod zoo-0 --namespace kafka
Name:         zoo-0
Namespace:    kafka
Priority:     0
Node:         ip-192-168-55-180.eu-central-1.compute.internal/192.168.55.180
Start Time:   Wed, 25 Aug 2021 09:16:07 +0000
Labels:       app=zookeeper
              controller-revision-hash=zoo-6c497fb7b7
              statefulset.kubernetes.io/pod-name=zoo-0
              storage=persistent-regional
Annotations:  kubernetes.io/psp: eks.privileged
Status:       Running
IP:           192.168.53.2
IPs:
  IP:           192.168.53.2
Controlled By:  StatefulSet/zoo
Containers:
  zookeeper:
    Container ID:   docker://687361445b9ef20215c1d911a23bc291509e8352ce509dac15d1c982a85523a3
    Image:          wurstmeister/zookeeper
    Image ID:       docker-pullable://wurstmeister/zookeeper@sha256:7a7fd44a72104bfbd24a77844bad5fabc86485b036f988ea927d1780782a6680
    Ports:          2181/TCP, 2888/TCP, 3888/TCP
    Host Ports:     0/TCP, 0/TCP, 0/TCP
    State:          Running
      Started:      Wed, 25 Aug 2021 09:16:10 +0000
    Ready:          True
    Restart Count:  0
    Limits:
      memory:  1200Mi
    Requests:
      cpu:      500m
      memory:   500Mi
    Readiness:  exec [/bin/sh -c [ "imok" = "$(echo ruok | nc -w 1 -q 1 127.0.0.1 2181)" ]] delay=0s timeout=2s period=30s #success=1 #failure=3
    Environment:
      POD_NAME:          zoo-0 (v1:metadata.name)
      KAFKA_LOG4J_OPTS:  -Dlog4j.configuration=file:/etc/kafka/log4j.properties
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-864tw (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  default-token-864tw:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-864tw
    Optional:    false
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m28s  default-scheduler  Successfully assigned kafka/zoo-0 to ip-192-168-55-180.eu-central-1.compute.internal
  Normal  Pulling    4m27s  kubelet            Pulling image "wurstmeister/zookeeper"
  Normal  Pulled     4m25s  kubelet            Successfully pulled image "wurstmeister/zookeeper" in 1.153014296s
  Normal  Created    4m25s  kubelet            Created container zookeeper
  Normal  Started    4m25s  kubelet            Started container zookeeper


