#running kafka broker (using web image) within a container in a pod on eks
#broker should be able to connect to zk service already

ajuser:~/kafka-installation5/kubernetes $ cd
ajuser:~ $ vi kafka-installation5/kubernetes/kafka-docker.yaml 
ajuser:~ $ kubectl apply -f kafka-installation5/kubernetes/kafka-docker.yaml 
deployment.apps/kafka-broker0 created

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS              RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   0/1     ContainerCreating   0          10s
zk-0                            1/1     Running             0          113m
zk-1                            1/1     Running             0          112m
zk-2                            1/1     Running             0          112m

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   1/1     Running   0          14s
zk-0                            1/1     Running   0          113m
zk-1                            1/1     Running   0          112m
zk-2                            1/1     Running   0          112m

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   1/1     Running   0          16s
zk-0                            1/1     Running   0          113m
zk-1                            1/1     Running   0          112m
zk-2                            1/1     Running   0          112m

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   1/1     Running   0          18s
zk-0                            1/1     Running   0          113m
zk-1                            1/1     Running   0          112m
zk-2                            1/1     Running   0          112m

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   1/1     Running   0          20s
zk-0                            1/1     Running   0          113m
zk-1                            1/1     Running   0          112m
zk-2                            1/1     Running   0          112m

ajuser:~ $ kubectl exec -it kafka-broker0-f8d94d678-mbkcr /bin/bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

bash-5.1# ls
bin    dev    etc    home   kafka  lib    lib64  media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var

bash-5.1# kafka-topics.sh --list --bootstrap-server locacommand terminated with exit code 137
#pod crashed..

ajuser:~ $ kubectl get pods
NAME                            READY   STATUS             RESTARTS   AGE
kafka-broker0-f8d94d678-mbkcr   0/1     CrashLoopBackOff   2          114s
zk-0                            1/1     Running            0          115m
zk-1                            1/1     Running            0          114m
zk-2                            1/1     Running            0          113m

ajuser:~ $ kubectl describe pod kafka-broker0-f8d94d678-mbkcr
Name:         kafka-broker0-f8d94d678-mbkcr
Namespace:    default
Priority:     0
Node:         ip-192-168-36-240.eu-central-1.compute.internal/192.168.36.240
Start Time:   Sun, 22 Aug 2021 21:16:13 +0000
Labels:       app=kafka
              id=0
              pod-template-hash=f8d94d678
Annotations:  kubernetes.io/psp: eks.privileged
Status:       Running
IP:           192.168.52.147
IPs:
  IP:           192.168.52.147
Controlled By:  ReplicaSet/kafka-broker0-f8d94d678
Containers:
  kafka:
    Container ID:   docker://0b3cd514f2a8ef2731a7727648fd8a39ad2cf59c7e38146a89f0ecf81730401d
    Image:          wurstmeister/kafka
    Image ID:       docker-pullable://wurstmeister/kafka@sha256:4bad02cf8f07d0bf65d5cc73cce7aa75f9a90e32b585f867fce7c3fff229bd6d
    Port:           9092/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       CrashLoopBackOff
    Last State:     Terminated
      Reason:       Error
      Exit Code:    1
      Started:      Sun, 22 Aug 2021 21:18:10 +0000
      Finished:     Sun, 22 Aug 2021 21:18:31 +0000
    Ready:          False
    Restart Count:  3
    Environment:
      KAFKA_ADVERTISED_PORT:       30718
      KAFKA_ADVERTISED_HOST_NAME:  localhost
      KAFKA_ZOOKEEPER_CONNECT:     zoo1:2181
      KAFKA_BROKER_ID:             0
      KAFKA_CREATE_TOPICS:         admintome-test:1:1
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pw8g7 (ro)
Conditions:
apiVersion: apps/v1
metadata:
  Type              Status
  Initialized       True 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  default-token-pw8g7:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pw8g7
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                  From               Message
  ----     ------     ----                 ----               -------
  Normal   Scheduled  2m32s                default-scheduler  Successfully assigned default/kafka-broker0-f8d94d678-mbkcr to ip-192-168-36-240.eu-central-1.compute.internal
  Normal   Pulled     2m22s                kubelet            Successfully pulled image "wurstmeister/kafka" in 8.744399117s
  Normal   Pulled     118s                 kubelet            Successfully pulled image "wurstmeister/kafka" in 1.134315542s
  Normal   Pulled     84s                  kubelet            Successfully pulled image "wurstmeister/kafka" in 1.138074664s
  Normal   Pulling    36s (x4 over 2m31s)  kubelet            Pulling image "wurstmeister/kafka"
  Normal   Created    35s (x4 over 2m21s)  kubelet            Created container kafka
  Normal   Started    35s (x4 over 2m21s)  kubelet            Started container kafka
  Normal   Pulled     35s                  kubelet            Successfully pulled image "wurstmeister/kafka" in 1.158124281s
  Warning  BackOff    2s (x5 over 97s)     kubelet            Back-off restarting failed container

#failure was due to kafka broker not able to find zk service as mentioned in YAML file

#delete pods
ajuser:~ $ kubectl delete -f kafka-installation5/kubernetes/kafka-docker.yaml                                                              
deployment.apps "kafka-broker0" deleted

#edit file
ajuser:~ $ vi kafka-installation5/kubernetes/kafka-docker.yaml                                                                             

#deploy
ajuser:~ $ kubectl apply -f kafka-installation5/kubernetes/kafka-docker.yaml 
deployment.apps/kafka-broker0 created

kafka-broker0-766479dc64-fzzwq   1/1     Running   0          7s
zk-0                             1/1     Running   0          116m
zk-1                             1/1     Running   0          116m
zk-2                             1/1     Running   0          115m

ajuser:~ $ kubectl exec -it kafka-broker0-766479dc64-fzzwq /bin/bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
bash-5.1# kafka-topics.sh --list --bootstrap-server localhost:9092


bash-5.1# kafka-topics.sh --list --zookeeper zk-hs:2181                                                                                    
admintome-test
bash-5.1# ls
bin    dev    etc    home   kafka  lib    lib64  media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var
bash-5.1# exit
exit
